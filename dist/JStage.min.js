!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t=t||self).JStage=e()}(this,function(){"use strict";var r=function(t,e,i,s,n){this.transforms=["scaleX","scaleY","skewX","skewY","rotate","translateX","translateY"],this.id=r.i++,this.property=t,this.value=e,this.duration=this.normalizeTime(i),this.timingFunction=n||"linear",this.delay=this.normalizeTime(s),this.status=r.IDLE};r.i=0,r.IDLE=0,r.EXECUTING=1,r.SKIP=2,r.COMPLETE=3,r.prototype={reset:function(){this.status=r.IDLE},executing:function(){this.status=r.EXECUTING},skip:function(){this.status=r.SKIP},complete:function(){this.status=r.COMPLETE},isExecuting:function(){return this.status===r.EXECUTING},isSkip:function(){return this.status===r.SKIP},isComplete:function(){return this.status===r.COMPLETE},normalizeTime:function(t){return t?"number"==typeof t?t:0<t.indexOf("ms")?t.slice(0,-2)-0:0<t.indexOf("s")?1e3*t.slice(0,-1):isNaN(t)?t:void 0:0},getProgressValue:function(t){return t*this.value}};var s={applyFunc:function(t,e){var i;return i="applyFunc"!==t&&void 0!==s[t]?t:"linear",s[i](e)},linear:function(t){return t},easeInQuad:function(t){return t*t},easeOutQuad:function(t){return t*(2-t)},easeInOutQuad:function(t){return t<.5?2*t*t:(4-2*t)*t-1},easeInCubic:function(t){return t*t*t},easeOutCubic:function(t){return--t*t*t+1},easeInOutCubic:function(t){return t<.5?4*t*t*t:(t-1)*(2*t-2)*(2*t-2)+1},easeInQuart:function(t){return t*t*t*t},easeOutQuart:function(t){return 1- --t*t*t*t},easeInOutQuart:function(t){return t<.5?8*t*t*t*t:1-8*--t*t*t*t},easeInQuint:function(t){return t*t*t*t*t},easeOutQuint:function(t){return 1+--t*t*t*t*t},easeInOutQuint:function(t){return t<.5?16*t*t*t*t*t:1+16*--t*t*t*t*t}},u=function(t,e,i,s,n){this.el,this.state={},this.intermediateState={},this.setups={},this.loops={},this.propDiff={},this.executingScripts={},this.currentSetup,this.width,this.height,this.left,this.top,this.duration=0,this.stage,this.status=u.IS_STATIC,this.setEl(t),this.setSize(e,i),this.setPosition(s,n)};u.PROP_DEFAULT={scale:1,scaleX:1,scaleY:1,translateX:0,translateY:0,rotate:0,skew:0,skewX:0,skewY:0},u.TRANSFORMS=["translateX","translateY","rotate","skew","skewX","skewY","scale","scaleX","scaleY"],u.INIT_SETUP="INIT_SETUP",u.OPEN_SETUP="OPEN_SETUP",u.IS_IDLE=0,u.IS_COMPLETED=2,u.IS_ANIMATING=3,u.IS_STATIC=4,u.addBatchSetups=function(t,i){t.forEach(function(t){for(var e in i)t.addSetup(e,i[e])})},u.prototype={setState:function(t,e){return this.state[t]=e,this},getPropDefaultValue:function(t){return void 0===u.PROP_DEFAULT[t]?0:u.PROP_DEFAULT[t]},createSetup:function(t){void 0===this.getSetup(t)&&(this.setups[t]={key:t,scripts:[],setups:[],index:0,startTimestamp:null})},addSetup:function(e,t){this.createSetup(e);var i=this.getSetup(e);return t instanceof Array&&0<t.length&&t.forEach(function(t){this.addScript(e,t)},this),i.duration=this.getDuration(i),this},addSetups:function(t){for(var e in t)this.addSetup(e,t[e])},addLoopSetup:function(i,t){this.createSetup(i),t.forEach(function(t){var e=this.getSetup(t);e&&this.getSetup(i).setups.push(e)},this)},addOpenSetup:function(t){return this.addSetup(u.OPEN_SETUP,t),this},addScript:function(t,e){return this.createSetup(t),this.status=u.IS_IDLE,this.setups[t].scripts.push(new r(e.property,e.value,e.duration,e.delay,e.timingFunction)),this},getSetup:function(t){return this.setups[t]},getPropValue:function(t,e){return void 0===t[e]?this.getPropDefaultValue(e):t[e]},getPropDiffVal:function(t,e,i){if(-1<t.toLowerCase().indexOf("color"))throw"unsupported property "+t;return i-e},createPropDiff:function(t){var e,i=t.property;e="string"!=typeof t.value||0!==t.value.indexOf("+")&&0!==t.value.indexOf("-")?t.value:this.getPropValue(this.state,i)+parseInt(t.value),this.propDiff[t.property]={prop:i,diffVal:this.getPropDiffVal(t.property,this.getPropValue(this.state,i),e),fromVal:this.getPropValue(this.state,i),easing:t.timingFunction}},patchPropDiff:function(t,e){var i,s=e.property;i="string"!=typeof e.value||0!==e.value.indexOf("+")&&0!==e.value.indexOf("-")?e.value:this.getPropValue(this.intermediateState,s)+parseInt(e.value),t.diffVal=this.getPropDiffVal(e.property,this.getPropValue(this.intermediateState,s),i),t.fromVal=this.getPropValue(this.intermediateState,s)},getPropDiff:function(t){return this.propDiff[t]},updateIntermediateState:function(t,e){this.intermediateState[t.prop]=t.diffVal*s.applyFunc(t.easing,e)+t.fromVal},update:function(t){return!(!this.hasSetup(t)||this.isStatic()||this.isCompleted())&&(this.render(void 0===t?u.OPEN_SETUP:t),!0)},stop:function(t){this.complete();var e=this.getSetup(t);0<e.setups.length&&(e.index=0)},render:function(){var i=this.currentSetup;if(i){if(0<i.setups.length){var s=i.setups[i.index];s.startTimestamp||(s.startTimestamp=o.now());var n=this.getCurrentTimestamp();s.scripts.forEach(function(t){if(!(t.isComplete()||t.isSkip()||(r=s.startTimestamp,a=!1,0<t.delay&&(r+=t.delay),n<r))){var e=(n-r)/t.duration;1<e&&(e=1),t.executing(),void 0===this.executingScripts[t.property]&&(this.executingScripts[t.property]=t,this.createPropDiff(t)),this.executingScripts[t.property]===t||t.isSkip()||t.isComplete()||(this.executingScripts[t.property].isExecuting()&&this.executingScripts[t.property].skip(),this.executingScripts[t.property]=t,this.patchPropDiff(this.getPropDiff(t.property),t)),this.updateIntermediateState(this.getPropDiff(t.property),e),1===e&&t.complete()}},this),!1!==a&&(s.startTimestamp=null,i.index>=i.setups.length-1?i.index=0:i.index++,this.standbyLoop(i))}else{var r;i.startTimestamp||(i.startTimestamp=this.getStartTimestamp());var a;n=this.getCurrentTimestamp();i.scripts.forEach(function(t){if(!(t.isComplete()||t.isSkip()||(r=i.startTimestamp,a=!1,0<t.delay&&(r+=t.delay),n<r))){var e=(n-r)/t.duration;1<e&&(e=1),t.executing(),void 0===this.executingScripts[t.property]&&(this.executingScripts[t.property]=t,this.createPropDiff(t)),this.executingScripts[t.property]===t||t.isSkip()||t.isComplete()||(this.executingScripts[t.property].isExecuting()&&this.executingScripts[t.property].skip(),this.executingScripts[t.property]=t,this.patchPropDiff(this.getPropDiff(t.property),t)),this.updateIntermediateState(this.getPropDiff(t.property),e),1===e&&t.complete()}},this),!1===a?this.status=u.IS_ANIMATING:(this.status=u.IS_COMPLETED,i.startTimestamp=null)}this.renderState()}},renderState:function(){var t="";for(var e in this.intermediateState)if(-1<u.TRANSFORMS.indexOf(e))switch(e){case"translateX":case"translateY":t+=e+"("+this.intermediateState[e]+this.getScale()+"px) ";break;case"rotate":case"skew":case"skewX":case"skewY":t+=e+"("+this.intermediateState[e]+"deg) ";break;case"scale":case"scaleX":case"scaleY":t+=e+"("+this.intermediateState[e]+") "}else-1<["left","top","width","height"].indexOf(e)?this.el.style[e]=this.intermediateState[e]*this.getScale()+"px":this.el.style[e]=this.intermediateState[e];void 0!==t&&o.setStyle(this.el,"transform",t)},setSize:function(t,e){return this.width=t,this.height=e,this.setState("width",t).setState("height",e),this},setPosition:function(t,e){return this.left=t,this.top=e,this.setState("left",t).setState("top",e),this},getScale:function(){return this.stage.scale},getStartTimestamp:function(){return this.stage.startTimestamp},getCurrentTimestamp:function(){return this.stage.currentTimestamp},getReady:function(){var t=this.getSetup(u.OPEN_SETUP);for(var e in void 0!==t&&(this.resetSetup(t),this.duration=this.getDuration(t)),this.intermediateState={},this.state)this.intermediateState[e]=this.state[e];this.renderState()},getSetupReady:function(t){this.intermediateState={};var e=this.getSetup(t),i=this.getFinState(e);for(var s in e.scripts)void 0===i[s]&&(i[s]=e.scripts[s]);for(var s in i)this.intermediateState[s]=i[s];this.duration=this.getDuration(e),this.renderState()},setEl:function(t){this.el=o.getEl(t)},isAnimating:function(){return this.status===u.IS_ANIMATING},isCompleted:function(){return this.status===u.IS_COMPLETED},complete:function(){this.status=u.IS_COMPLETED},isStatic:function(){return this.status===u.IS_STATIC},isIdle:function(){return this.status===u.IS_IDLE},recal:function(){this.isAnimating()||this.renderState()},appendToStage:function(t){t.appendObj(this)},setStage:function(t){this.stage=t},reset:function(){this.getReady()},setTime:function(t){},getDuration:function(t){var e=0,i=0;return t.scripts.forEach(function(t){i=t.duration+t.delay,e<i&&(e=i)}),e},getFinState:function(t){var e={},i={};return t.scripts.forEach(function(t){void 0===i[t.property]?(i[t.property]=t.delay,e[t.property]=t.property):t.delay>i[t.property]&&(i[t.property]=t.delay,e[t.property]=t.property)}),e},resetSetup:function(t){t.scripts.forEach(function(t){t.reset()})},standby:function(t){var e="object"==typeof t?t:this.getSetup(t);void 0!==e&&(0<e.setups.length&&e.setups.forEach(function(t){this.standby(t)},this),(this.currentSetup=e).startTimestamp=null,this.status=u.IS_IDLE,this.resetSetup(e))},standbyLoop:function(t){this.standby(t.setups[t.index]),this.currentSetup=t},hasSetup:function(t){return void 0!==this.setups[t]}};var i={start:function(){o.inProgress||(window.requestAnimationFrame?window.requestAnimationFrame(i.update):setTimeout(i.update,o.interval))},update:function(e){e=e||o.now();o.inProgress=!0,o.stages.forEach(function(t){t.update(e)}),window.requestAnimationFrame?window.requestAnimationFrame(i.update):setTimeout(i.update,o.interval)}};function o(t,e,i){if(!o.createFromStatic)throw"You should use JStage.createStage() method to create stage";o.createFromStatic=!1,this.el=o.getEl(t),this.width=e,this.height=i,this.scale,this.startTimestamp,this.currentTimestamp,this.duration=0,this.status=o.STATUS_IDLE,this.currentSetupOffsets=[],this.loops=[],this.resources=[],this.objs=[]}return o.createFromStatic=!1,o.interval=13,o.inProgress=!1,o.stages=[],o.STATUS_IDLE=0,o.STATUS_IN_PROGRESS=1,o.STATUS_COMPLETE=2,o.now=function(){return performance&&performance.now?performance.now():Date.now()},o.setStyle=function(t,e,i){var s=["ms","webkit","moz"];if(void 0!==t.style[e])t.style[e]=i;else{var n;e=e.charAt(0).toUpperCase()+e.slice(1);for(var r=0,a=s.length;r<a;r++)if(n=s[r]+e,void 0!==t.style[n]){t.style[n]=i;break}}},o.getEl=function(t){if("string"==typeof t){if(document.querySelector)return document.querySelector(t);if(0===t.indexOf("#"))return document.getElementById(t.slice(1));throw"el should be a string if it's not a Node"}if(jQuery&&t instanceof jQuery)return t[0];if("object"==typeof t&&t instanceof Node&&0<t.nodeType)return t;throw"Invalid el"},o.normalizeTime=function(t){return t?"number"==typeof t?t:0<t.indexOf("ms")?t.slice(0,-2)-0:0<t.indexOf("s")?1e3*t.slice(0,-1):isNaN(t)?t:void 0:0},o.getStyle=function(t,e){return void 0===typeof getComputedStyle?t.currentStyle[e]:getComputedStyle(t,null).getPropertyValue(e)},o.create=function(t,e,i){o.createFromStatic=!0;var s=new o(t,e,i);return o.stages.push(s),s},o.prototype={addResource:function(t){return this.resources.indexOf(t)<0&&this.resources.push(t),this},loadResources:function(i){var s=this.resources.length,n=0;this.resources.forEach(function(t){var e=new Image;e.onload=function(){n++,i.onProgress&&"function"==typeof i.onProgress&&i.onProgress.call(this,s,n),n===s&&i.onComplete&&"function"==typeof i.onComplete&&i.onComplete.call(null)},e.src=t,e.complete&&e.load()})},createObj:function(t,e,i,s,n){var r=new u(t,e,i,s,n);return this.appendObj(r),r},inProgress:function(){return this.status===o.STATUS_IN_PROGRESS},isComplete:function(){return this.status===o.STATUS_COMPLETE},isIdle:function(){return this.status===o.STATUS_IDLE},inSetup:function(t){return-1<this.currentSetupOffsets.indexOf(t)},addCurrentSetupOffset:function(t){this.currentSetupOffsets.indexOf(t)<0&&this.currentSetupOffsets.push(t)},removeFromCurrentSetups:function(t){var e=this.currentSetupOffsets.indexOf(t);-1<e&&this.currentSetupOffsets.splice(e,1)},init:function(){var e=this;this.setScale(this.el.offsetWidth,this.el.offsetHeight),this.el.style.width=this.width*this.scale+"px",this.el.style.height=this.height*this.scale+"px",this.objs.forEach(function(t){t.getReady(),t.duration>e.duration&&(e.duration=t.duration)})},standby:function(e){this.startTimestamp=null,this.currentTimestamp=null,this.status=o.STATUS_IDLE,void 0!==e&&this.objs.forEach(function(t){t.standby(e)},this)},resizeEl:function(t,e){this.setScale(t,e),this.el.style.width=this.width*this.scale+"px",this.el.style.height=this.height*this.scale+"px",this.objs.forEach(function(t){t.recal()})},setScale:function(t,e){var i=t/this.width,s=e/this.height;return this.scale=s<i?s:i,this},start:function(){this.startSetup(u.OPEN_SETUP)},startSetup:function(t){this.inSetup(t)||(this.addCurrentSetupOffset(t),this.standby(t),this.startTimestamp=o.now(),i.start())},stopSetup:function(e){this.objs.forEach(function(t){t.hasSetup(e)&&t.stop(e)})},update:function(t){return!this.isComplete()&&(this.updateSetup(t),!0)},updateSetup:function(t){this.currentTimestamp=t,0<this.currentSetupOffsets.length?(this.status=o.STATUS_IN_PROGRESS,this.currentSetupOffsets.forEach(function(e){var i;this.objs.forEach(function(t){t.update(e)&&(i=!1)},this),void 0===i&&this.removeFromCurrentSetups(e)},this)):this.status=o.STATUS_COMPLETE},setTime:function(t){},setProgress:function(t){},appendObj:function(t){t.stage||t.stage===this||(this.objs.push(t),t.setStage(this))}},o});//# sourceMappingURL=JStage.min.js.map
